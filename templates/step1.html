<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“æè¿°ä¼˜åŒ– - AIåŠ©æ‰‹</title>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow-x: hidden; /* é¿å…ä¸‹æ‹‰èœå•/ç»å¯¹å®šä½å…ƒç´ å¯¼è‡´æ¨ªå‘æ»šåŠ¨æ¡ */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff; /* ç»Ÿä¸€é¡µé¢èƒŒæ™¯ï¼Œé¿å…æ»šåŠ¨æ—¶ä¸Šä¸‹å‡ºç°ä¸åŒåº•è‰² */
            min-height: 100vh;
            color: #0f172a;
            line-height: 1.6;
            display: block; /* sidebar æ”¹ä¸º fixed åä¸å†éœ€è¦ body flex */
            overflow-y: scroll; /* å¼ºåˆ¶é¡µé¢æ»šåŠ¨æ¡åœ¨æœ€å³ä¾§ï¼ˆè´´è¿‘ ChatGPTï¼‰ */
            -webkit-font-smoothing: antialiased;
        }

        /* é¡µé¢æ»šåŠ¨æ¡ï¼ˆè´´è¿‘ ChatGPT çš„çª„æ»šåŠ¨æ¡ï¼‰ */
        body::-webkit-scrollbar {
            width: 8px;
        }

        body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        body::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        body::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ä¾§è¾¹æ æ»šåŠ¨æ¡ä¿æŒåŸæ · */
        .sidebar-scrollable::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scrollable::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scrollable::-webkit-scrollbar-thumb {
            background: #d1d1d1;
            border-radius: 3px;
        }

        .sidebar-scrollable::-webkit-scrollbar-thumb:hover {
            background: #b1b1b1;
        }

        /* ========== ä¾§è¾¹æ æ ·å¼ ========== */
        .sidebar {
            width: 260px;
            background: #f7f7f8;
            border-right: 1px solid #ececec;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
            position: fixed; /* å›ºå®šåœ¨å·¦ä¾§ï¼Œæ»šåŠ¨æ—¶ä¸æ¶ˆå¤± */
            left: 0;
            top: 0;
            bottom: 0;
            height: auto;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar.hidden {
            display: none;
        }

        .sidebar-header {
            padding: 8px;
        }

        .new-chat {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: transparent;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            width: 100%;
            font-size: 14px;
            color: #1f1f1f;
            font-weight: 500;
            transition: background 0.2s;
        }

        .new-chat:hover {
            background: #ececec;
        }

        .new-chat svg {
            width: 18px;
            height: 18px;
        }

        .search-section {
            padding: 8px;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-box svg {
            position: absolute;
            left: 12px;
            width: 16px;
            height: 16px;
            color: #8e8e93;
        }

        .search-box input {
            width: 100%;
            padding: 9px 12px 9px 36px;
            border: none;
            background: #ececec;
            border-radius: 8px;
            font-size: 14px;
            color: #1f1f1f;
            outline: none;
            transition: background 0.2s;
        }

        .search-box input:focus {
            background: #e0e0e0;
        }

        .search-box input::placeholder {
            color: #8e8e93;
        }

        .menu-section {
            padding: 4px 8px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            color: #1f1f1f;
            border-radius: 8px;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .menu-item:hover {
            background: #ececec;
        }

        .menu-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge {
            background: #e0e0e0;
            color: #5e5e5e;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .divider {
            height: 1px;
            background: #ececec;
            margin: 8px 0;
        }

        .sidebar-scrollable {
            flex: 1;
            overflow-y: auto;
            padding: 0 8px;
        }

        .section-title {
            padding: 12px 12px 6px 12px;
            font-size: 11px;
            color: #8e8e93;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .chat-list-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            color: #1f1f1f;
            border-radius: 8px;
            transition: background 0.2s;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-list-item:hover {
            background: #ececec;
        }

        .chat-list-item {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-list-item .chat-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-list-item .delete-btn {
            display: none;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #8e8e93;
            border-radius: 4px;
            flex-shrink: 0;
            margin-left: 4px;
            padding: 0;
            align-items: center;
            justify-content: center;
        }

        .chat-list-item:hover .delete-btn {
            display: flex;
        }

        .chat-list-item .delete-btn:hover {
            background: #e0e0e0;
            color: #dc2626;
        }

        /* ========== è½»é‡ç¡®è®¤å¼¹çª—ï¼ˆæ›¿ä»£æµè§ˆå™¨ confirmï¼‰ ========== */
        .ps-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease;
            z-index: 9999;
        }

        .ps-modal-backdrop.is-open {
            opacity: 1;
            pointer-events: auto;
        }

        .ps-modal {
            width: 360px;
            max-width: 100%;
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            padding: 16px;
        }

        .ps-modal-title {
            font-size: 15px;
            font-weight: 600;
            color: #0f172a;
            margin: 0;
        }

        .ps-modal-desc {
            font-size: 13px;
            color: #64748b;
            margin-top: 6px;
            line-height: 1.5;
        }

        .ps-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 14px;
        }

        .ps-btn {
            height: 34px;
            padding: 0 12px;
            border-radius: 10px;
            border: 1px solid transparent;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .ps-btn-ghost {
            background: #f1f5f9;
            color: #0f172a;
        }

        .ps-btn-ghost:hover {
            background: #e2e8f0;
        }

        .ps-btn-danger {
            background: #dc2626;
            color: #ffffff;
        }

        .ps-btn-danger:hover {
            background: #b91c1c;
        }

        .example-item {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 13px;
            color: #5e5e5e;
            border-radius: 8px;
            transition: all 0.2s;
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .example-item:hover {
            background: #ececec;
            color: #1f1f1f;
        }

        /* ========== ä¸»å®¹å™¨æ ·å¼ ========== */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: visible;
            min-height: 100vh;
            height: auto;
            background: #ffffff;
            position: relative;
            margin-left: 260px; /* ç»™ fixed sidebar ç•™å‡ºç©ºé—´ */
        }

        /* sidebar éšè—æ—¶ï¼ˆå¦‚æœæœ‰ç”¨åˆ° hidden ç±»ï¼‰ï¼Œä¸»å†…å®¹è‡ªåŠ¨è´´å·¦ */
        .sidebar.hidden + .main-wrapper {
            margin-left: 0;
        }

        /* ========== å¼€å§‹é¡µé¢æ ·å¼ (æ— å¯¹è¯æ—¶) ========== */
        .start-container {
            max-width: 900px;  /* ä»720pxå¢åŠ åˆ°900px */
            width: 100%;
            margin: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            overflow-y: auto;
        }

        .start-container.hidden {
            display: none;
        }

        .start-title {
            text-align: center;
            font-size: 36px;
            font-weight: 400;
            color: #1a1a1a;
            margin-bottom: 48px;
            letter-spacing: -0.5px;
        }

        .start-input-container {
            background: #ffffff;
            border-radius: 28px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06),
                        0 4px 16px rgba(0, 0, 0, 0.04);
            padding: 24px 28px;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 0, 0, 0.04);
            transition: box-shadow 0.3s ease;
        }

        .start-input-container:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08),
                        0 8px 24px rgba(0, 0, 0, 0.06);
        }

        .start-input-box {
            border: none;
            outline: none;
            width: 100%;
            font-size: 15px;
            color: #1a1a1a;
            margin-bottom: 18px;
            background: transparent;
            line-height: 1.5;
            resize: none;
            font-family: inherit;
            min-height: 24px;
        }

        .start-input-box::placeholder {
            color: #a0a0a0;
            font-weight: 300;
        }

        .start-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .start-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border: 1px solid #e5e5e5;
            border-radius: 10px;
            background: #ffffff;
            cursor: pointer;
            font-size: 13px;
            color: #404040;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 400;
        }

        .start-btn:hover {
            background: #fafafa;
            border-color: #d0d0d0;
        }

        .start-btn:active {
            transform: scale(0.98);
        }

        .start-btn-primary {
            margin-left: auto;
            background: #1a1a1a;
            color: #ffffff;
            border: none;
        }

        .start-btn-primary:hover {
            background: #2d2d2d;
        }

        .start-features {
            display: flex;
            gap: 4px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .start-feature {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-size: 14px;
            color: #606060;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            position: relative;
        }

        .start-feature:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 14px;
            background: #e0e0e0;
        }

        .start-feature:hover {
            color: #1a1a1a;
            background: #f8f8f8;
        }

        /* ========== èŠå¤©è¿›è¡Œä¸­æ ·å¼ ========== */
        .chat-container {
            flex: 1;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            overflow: visible;
            padding: 0;
            min-height: 0;
        }

        .chat-layout {
            display: block;
            padding: 0;
            overflow: visible; /* è®©å†…å®¹æ’‘å¼€é¡µé¢é«˜åº¦ï¼Œä½¿ç”¨ body æ»šåŠ¨æ¡ */
            height: auto;
        }

        .chat-stack {
            min-width: 0;
            display: block;
            overflow: visible;
        }

        .chat-container.hidden {
            display: none;
        }

        /* èŠå¤©å¤´éƒ¨ */
        .chat-header {
            padding: 12px 0;
            border-bottom: 1px solid #ececec;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-height: 56px;
            flex: 0 0 auto;
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.9);
        }

        .chat-header .model-selector {
            width: calc(100% - 32px);
            max-width: 760px;
        }

        .model-selector {
            position: relative;
        }

        .model-select-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 999px;
            cursor: pointer;
            font-size: 15px;
            color: #0f172a;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
        }

        .model-select-btn:hover {
            background: #ececec;
            border-color: #d1d1d1;
        }

        .model-select-btn svg {
            width: 16px;
            height: 16px;
        }

        .model-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: white;
            border: 1px solid #ececec;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 280px;
            width: 320px; /* è´´è¿‘ ChatGPT çš„ä¸‹æ‹‰å®½åº¦ */
            max-width: calc(100vw - 32px); /* é˜²æ­¢æº¢å‡ºè§†å£å¯¼è‡´æ¨ªå‘æ»šåŠ¨æ¡ */
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            display: none;
        }

        /* å¯åŠ¨é¡µå³ä¾§çš„æ¨¡å‹é€‰æ‹©å™¨ï¼šä¸‹æ‹‰å‘å†…å±•å¼€ï¼ˆå³å¯¹é½ï¼‰ï¼Œé¿å…æ’‘å‡ºé¡µé¢ */
        #modelDropdownStart {
            left: auto;
            right: 0;
        }

        .model-dropdown.show {
            display: block;
        }

        .model-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f7f7f8;
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .model-option:hover {
            background: #f7f7f8;
        }

        .model-option.active {
            background: #e5f3ff;
        }

        .model-option-name {
            font-size: 14px;
            font-weight: 500;
            color: #1f1f1f;
            margin-bottom: 2px;
        }

        .model-option-desc {
            font-size: 12px;
            color: #8e8e93;
        }

        .messages {
            flex: 0 0 auto;
            padding: 28px 16px 140px; /* åº•éƒ¨ç•™å‡ºè¾“å…¥æ¡†ç©ºé—´ */
            overflow: visible; /* ä½¿ç”¨é¡µé¢æ»šåŠ¨æ¡ */
            width: 100%;
            max-width: 760px; /* ChatGPT é£æ ¼ï¼šå±…ä¸­å¯¹è¯åˆ— */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: auto;
        }

        .message {
            margin: 0;
            display: flex;
            gap: 0;
            max-width: 100%;
        }

        .message.user {
            margin-left: auto;
            justify-content: flex-end;
        }

        .message.user .message-content {
            font-size: 15px;
            white-space: pre-wrap;
            background: #f4f4f5;
            color: #0f172a;
            padding: 14px 16px;
            border-radius: 18px;
            border: 1px solid #e4e4e7;
            box-shadow: none;
            max-width: min(560px, 100%);
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message.assistant .message-content {
            background: transparent;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none;
            max-width: 100%;
        }

        .message-content {
            font-size: 15px;
            color: #1a1a1a;
        }

        .message-content p {
            margin-bottom: 16px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: bold;
        }

        .message-content h1 { font-size: 1.5em; }
        .message-content h2 { font-size: 1.3em; }
        .message-content h3 { font-size: 1.2em; }
        .message-content h4 { font-size: 1.1em; }

        .message-content ul,
        .message-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }

        .message-content li {
            margin-bottom: 0.5em;
            line-height: 1.6;
        }

        .message-content code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message-content pre {
            background-color: #f4f4f4;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .message-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .message-content blockquote {
            border-left: 3px solid #e0e0e0;
            padding-left: 16px;
            margin: 16px 0;
            font-style: italic;
            color: #444;
        }

        .separator {
            border: none;
            border-top: 1px solid #e8e8e8;
            margin: 32px 0;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-container {
            display: none;
            padding: 20px 0;
            text-align: center;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #1a1a1a;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 14px;
            margin-top: 12px;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-container {
            padding: 14px 0 20px;
            border-top: 1px solid #e5e7eb;
            background: linear-gradient(to top, rgba(255,255,255,0.98), rgba(255,255,255,0.92));
            position: fixed; /* ChatGPTï¼šè¾“å…¥æ¡†å›ºå®šåœ¨è§†çª—åº•éƒ¨ */
            left: 260px;     /* è®©è¾“å…¥æ é¿å¼€å·¦ä¾§ fixed sidebar */
            right: 0;
            bottom: 0;
            backdrop-filter: blur(8px);
            flex: 0 0 auto;
            z-index: 50;
        }

        .chat-input-container form {
            max-width: 760px;
            width: calc(100% - 32px);
            margin: 0 auto;
        }

        /* å†…è”é¢æ¿æ˜¯ä¸€ä¸ªâ€œå¯Œå†…å®¹å¡ç‰‡â€ï¼Œä¿æŒåŸæœ‰å¡ç‰‡é£æ ¼ä¸å®½åº¦ */
        #inlinePanelMessage {
            width: 100%;
            max-width: 760px;
            margin: 0 auto;
        }

        #inlinePanelMessage .message-content {
            background: #ffffff;
            padding: 16px 18px;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
        }

        @media (max-width: 768px) {
            .chat-input-container {
                left: 0; /* ç§»åŠ¨ç«¯é€šå¸¸æ— ä¾§è¾¹æ å ä½ */
            }
            .main-wrapper {
                margin-left: 0;
            }
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
            }
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 12px;
        }

        .chat-input-field {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #d4d4d4;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
            resize: none;
            min-height: 50px;
        }

        .chat-input-field:focus {
            border-color: #999;
        }

        .chat-input-field::placeholder {
            color: #999;
        }

        .input-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        /* éšè—å·¦ä¾§çš„è¾…åŠ©æŒ‰é’® */
        .left-actions {
            display: none;
        }

        .send-btn {
            background-color: #111827;
            color: white;
            padding: 10px 18px;
            border-radius: 999px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .send-btn:hover {
            background-color: #0b1220;
        }

        .send-btn:active {
            transform: translateY(1px);
        }

        .send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* å³ä¾§ç”Ÿæˆé¢æ¿ */
        .inline-panel {
            width: 100%;
            max-width: 480px;
            background: transparent;
            border: none;
            border-radius: 12px;
            box-shadow: none;
            padding: 0;
            overflow: visible;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .inline-panel.hidden {
            display: none;
        }

        .inline-panel h3 {
            font-size: 16px;
            margin-bottom: 8px;
            font-weight: 700;
            color: #0f172a;
        }

        .inline-panel label {
            font-size: 13px;
            color: #475569;
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
        }

        .inline-panel select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d4d4d4;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
        }

        .inline-panel .hint {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            line-height: 1.5;
        }

        .inline-panel .primary-btn {
            background: #111827;
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            transition: background 0.2s, transform 0.1s;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
        }

        .inline-panel .primary-btn:hover {
            background: #0b1220;
        }

        .inline-panel .primary-btn:active {
            transform: translateY(1px);
        }

        .progress-list {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .progress-item {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: #f8fafc;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #0f172a;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e1;
            flex-shrink: 0;
        }

        .progress-item.active .progress-dot {
            background: #111827;
        }

        .progress-item.done .progress-dot {
            background: #22c55e;
        }

        .report-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 14px;
            background: #f9fafb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }

        .report-card.hidden {
            display: none;
        }

        .report-card h4 {
            margin-bottom: 10px;
            font-size: 15px;
        }

        .report-meta {
            font-size: 12px;
            color: #475569;
            margin-bottom: 8px;
        }

        .inline-token {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            color: #475569;
        }

        .inline-token .bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
        }

        .inline-token .fill {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #22c55e, #3b82f6);
            transition: width 0.3s ease;
        }

        .inline-section {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .inline-section:last-child {
            border-bottom: none;
        }

        .inline-block {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.04);
            overflow: hidden;
        }

        .inline-block .inline-section:first-child {
            background: #f8fafc;
        }

        .inline-progress-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .inline-status {
            font-size: 12px;
            font-weight: 700;
            color: #0f172a;
            background: #e2e8f0;
            border-radius: 999px;
            padding: 6px 10px;
            white-space: nowrap;
        }

        .inline-status.active {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .inline-status.done {
            background: #dcfce7;
            color: #166534;
        }

        .inline-status.failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .inline-pct {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            color: #475569;
        }

        .inline-pct .bar {
            width: 100%;
            height: 10px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
        }

        .inline-pct .fill {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #111827, #3b82f6);
            transition: width 0.3s ease;
        }

        .inline-pct.failed .fill {
            background: linear-gradient(90deg, #dc2626, #f97316);
        }

        .inline-section h4 {
            margin-bottom: 10px;
            font-size: 15px;
        }

        .inline-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .inline-steps .progress-item {
            margin: 0;
        }

        .confirm-btn {
            background-color: #22c55e;
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-left: 8px;
        }

        .confirm-btn:hover {
            background-color: #16a34a;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .start-container {
                max-width: 100%;
                padding: 16px;
            }

            .start-title {
                font-size: 28px;
                margin-bottom: 32px;
            }

            .messages {
                padding: 20px 20px;
            }

            .chat-input-container {
                padding: 16px 20px 24px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat" onclick="startNewConversation()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"></path>
                </svg>
                <span>æ–°å¯¹è¯</span>
            </button>
        </div>

        <div class="search-section">
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <input type="text" placeholder="æœç´¢å¯¹è¯" id="sidebarSearch">
            </div>
        </div>

        <div class="menu-section">
            <div class="menu-item" onclick="toggleLibrary()">
                <div class="menu-item-content">
                    <div class="menu-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                    </div>
                    <span>ç¤ºä¾‹é—®é¢˜</span>
                </div>
                <span class="badge" id="libraryCount">5</span>
            </div>
        </div>

        <div class="divider"></div>

        <div class="sidebar-scrollable">
            <!-- Library: ç¤ºä¾‹é—®é¢˜ -->
            <div id="librarySection" style="display: none;">
                <div class="section-title">Library</div>
                <div class="example-item" onclick="useExample(this)">
                    æˆ‘çš„äº§å“æ˜¯ä¸€æ¬¾é¢å‘å¤§å­¦ç”Ÿçš„äºŒæ‰‹äº¤æ˜“å¹³å°APP
                </div>
                <div class="example-item" onclick="useExample(this)">
                    å¼€å‘ä¸€ä¸ªå¸®åŠ©ä¸­å°ä¼ä¸šè¿›è¡Œæ•°å­—åŒ–è½¬å‹çš„SaaSæœåŠ¡å¹³å°
                </div>
                <div class="example-item" onclick="useExample(this)">
                    è®¾è®¡ä¸€æ¬¾æ™ºèƒ½å¥åº·ç®¡ç†APPï¼Œç»“åˆAIæä¾›ä¸ªæ€§åŒ–å¥åº·å»ºè®®
                </div>
                <div class="example-item" onclick="useExample(this)">
                    åˆ›å»ºä¸€ä¸ªè¿æ¥è‡ªç”±èŒä¸šè€…å’Œä¼ä¸šçš„è¿œç¨‹å·¥ä½œå¹³å°
                </div>
                <div class="example-item" onclick="useExample(this)">
                    æ„å»ºä¸€ä¸ªåŸºäºåŒºå—é“¾çš„ä¾›åº”é“¾æº¯æºç³»ç»Ÿ
                </div>
            </div>

            <!-- Chats: å†å²è®°å½• -->
            <div class="section-title">å†å²å¯¹è¯</div>
            <div id="chatHistory">
                <!-- å†å²è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <div class="chat-list-item" style="color: #8e8e93; text-align: center; padding: 20px;">
                    æš‚æ— å†å²è®°å½•
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-wrapper">
        <!-- å¼€å§‹é¡µé¢ -->
        <div class="start-container" id="startContainer">
            <h1 class="start-title">æè¿°æ‚¨çš„äº§å“åˆ›æ„</h1>

            <div class="start-input-container">
                <textarea class="start-input-box" id="startInput" rows="1" placeholder="å‘Šè¯‰AIé¡¾é—®æ‚¨çš„äº§å“ã€ç›®æ ‡ç”¨æˆ·ã€æ ¸å¿ƒåŠŸèƒ½ä»¥åŠä»·æ ¼åŒºé—´..."></textarea>

                <div class="start-buttons">
                    <button class="start-btn" onclick="fillExample()">
                        ğŸ’¡ å¿«é€Ÿè¯•ç”¨
                    </button>

                    <!-- æ¨¡å‹é€‰æ‹©å™¨æ”¾åœ¨å³ä¾§ -->
                    <div class="model-selector" style="margin-left: auto;">
                        <button class="model-select-btn" onclick="toggleModelDropdown()" style="margin: 0; padding: 8px 16px; font-size: 14px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                            <span id="currentModelNameStart">åŠ è½½ä¸­...</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                <path d="M6 9l6 6 6-6"></path>
                            </svg>
                        </button>

                        <!-- æ¨¡å‹ä¸‹æ‹‰èœå• -->
                        <div class="model-dropdown" id="modelDropdownStart">
                            <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="start-features">
                <div class="start-feature">
                    ğŸ¯ æ™ºèƒ½äº§å“ä¼˜åŒ–
                </div>
                <div class="start-feature">
                    ğŸ‘¥ ç”¨æˆ·ç”»åƒç”Ÿæˆ
                </div>
                <div class="start-feature">
                    ğŸ“Š å¸‚åœºååº”æ¨¡æ‹Ÿ
                </div>
            </div>
        </div>

        <!-- èŠå¤©è¿›è¡Œä¸­é¡µé¢ -->
        <div class="chat-container hidden" id="chatContainer">
            <div class="chat-layout" style="padding:0 0;">
                <div class="chat-stack">
                    <!-- èŠå¤©å¤´éƒ¨ - åŒ…å«æ¨¡å‹é€‰æ‹©å™¨ -->
                    <div class="chat-header">
                        <div class="model-selector">
                            <button class="model-select-btn" onclick="toggleModelDropdown()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="14" width="7" height="7"></rect>
                                    <rect x="3" y="14" width="7" height="7"></rect>
                                </svg>
                                <span id="currentModelName">åŠ è½½ä¸­...</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                    <path d="M6 9l6 6 6-6"></path>
                                </svg>
                            </button>

                            <!-- æ¨¡å‹ä¸‹æ‹‰èœå• -->
                            <div class="model-dropdown" id="modelDropdown">
                                <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                    </div>

                    <div class="messages" id="messagesContainer">
                    {% for message in conversation %}
                        {% if message.role == "user" %}
                            <div class="message user">
                                <div class="message-content">{{ message.content }}</div>
                            </div>
                        {% elif message.role == "assistant" and message.content != system_prompt %}
                            <div class="message assistant">
                                <div class="message-content markdown-content" data-markdown="{{ message.content }}"></div>
                            </div>
                        {% endif %}
                    {% endfor %}

                    <!-- åŠ è½½åŠ¨ç”» -->
                    <div class="loading-container" id="loadingIndicator">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">AIåŠ©æ‰‹æ­£åœ¨æ€è€ƒä¸­...</div>
                    </div>

                    <!-- å†…è”ç”Ÿæˆé¢æ¿ï¼Œä½œä¸ºåŠ©æ‰‹æ¶ˆæ¯å±•ç¤º -->
                    <div class="message assistant" id="inlinePanelMessage">
                        <div class="message-content">
                            <div class="inline-panel hidden" id="inlineStepPanel">
                                <!-- ä¸ŠåŠéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥å‘Š -->
                                <div class="inline-block">
                                    <div class="inline-section">
                                        <h3>ç”ŸæˆæŠ¥å‘Š</h3>
                                        <div class="hint">ç¡®è®¤äº§å“æè¿°åï¼Œç›´æ¥åœ¨æœ¬é¡µç”ŸæˆæŠ¥å‘Šï¼Œå…¨æµç¨‹å¯è§†åŒ–ï¼Œæ— éœ€æ”¯ä»˜ã€‚</div>
                                    </div>
                                    <div class="inline-section">
                                        <label for="num_personas">ç”Ÿæˆç”¨æˆ·ç”»åƒæ•°é‡</label>
                                        <input type="number" id="num_personas" min="1" max="999" value="2" oninput="updateSimulationsAndPrice()" style="width:100%;padding:10px 12px;border:1px solid #d4d4d4;border-radius:10px;font-size:14px;">
                                        <div class="hint">æ¨èï¼š2 ä¸ªï¼ˆå¿«é€Ÿä½“éªŒï¼‰ï¼›10+ å¯è·å¾—æ›´å…¨é¢åˆ†å±‚ã€‚</div>
                                    </div>
                                    <div class="inline-section">
                                        <label for="num_simulations">æ¯ä¸ªç”¨æˆ·æ¨¡æ‹Ÿæ¬¡æ•°</label>
                                        <input type="number" id="num_simulations" min="1" max="20" value="2" oninput="updatePrice()" style="width:100%;padding:10px 12px;border:1px solid #d4d4d4;border-radius:10px;font-size:14px;">
                                        <div class="hint">æ¨èï¼š2 æ¬¡ï¼›è‹¥éœ€æ›´ç¨³å®šç»“æœå¯å¡« 3-5 æ¬¡ã€‚</div>
                                    </div>
                                    <div class="inline-section">
                                        <div class="report-meta" id="reportMeta"></div>
                                        <button class="primary-btn" type="button" onclick="startInlineGeneration()" style="width:100%;margin-top:10px;">
                                            â–¶ ç”ŸæˆæŠ¥å‘Š
                                        </button>
                                    </div>
                                </div>

                                <!-- ä¸‹åŠéƒ¨åˆ†ï¼šè¿›åº¦ + ç»“æœ -->
                                <div class="inline-block">
                                    <div class="inline-section">
                                        <div class="inline-progress-head">
                                            <h4 style="margin:0;">è¿›åº¦</h4>
                                            <span class="inline-status" id="inlineStatusLabel">æœªå¼€å§‹</span>
                                        </div>
                                        <div class="inline-pct" id="inlinePctPanel">
                                            <div class="bar"><div class="fill" id="inlinePctFill"></div></div>
                                            <div><span id="inlinePctText">0</span>%</div>
                                        </div>
                                        <div class="inline-steps">
                                            <div class="progress-list" id="inlineProgress"></div>
                                        </div>
                                        <div class="inline-token" id="inlineTokenPanel" style="display:none;margin-top:10px;">
                                            <div class="bar"><div class="fill" id="inlineTokenFill"></div></div>
                                            <div><span id="inlineTokenUsed">0</span> / <span id="inlineTokenTotal">0</span> tokens</div>
                                        </div>
                                    </div>

                                    <div class="inline-section">
                                        <div class="report-card hidden" id="inlineReport">
                                            <h4>ç”ŸæˆæŠ¥å‘Š</h4>
                                            <div id="reportContent"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="chat-input-container">
                    <form id="chatForm">
                        <input type="hidden" name="conversation" value="{{ conversation_json }}">

                        <div class="input-wrapper">
                            <textarea class="chat-input-field" id="chatInput" rows="1" placeholder="ç»§ç»­å¯¹è¯..."></textarea>
                        </div>
                        <div class="input-actions">
                            <div class="left-actions">
                                <button type="button" class="input-btn" title="ä½¿ç”¨Enterå‘é€ï¼ŒShift+Enteræ¢è¡Œ">
                                    âŒ¨ï¸ Enterå‘é€
                                </button>
                                <button type="button" class="input-btn" onclick="startNewConversation()" title="æ¸…é™¤å½“å‰å¯¹è¯ï¼Œé‡æ–°å¼€å§‹">
                                    ğŸ”„ æ–°å¯¹è¯
                                </button>
                            </div>
                            <div>
                                <button type="submit" class="send-btn" id="sendBtn">
                                    å‘é€
                                </button>
                                {% if has_product_description %}
                                <button type="button" class="confirm-btn" onclick="showConfirmModal()">
                                    ç¡®è®¤å¹¶ä¸‹ä¸€æ­¥ â†’
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
                </div>
            </div>
        </div>
    </div> <!-- ç»“æŸ main-wrapper -->

    <script>
        // ========== ä¾§è¾¹æ äº¤äº’å‡½æ•° ==========

        // åˆ‡æ¢Libraryæ˜¾ç¤º/éšè—
        function toggleLibrary() {
            const librarySection = document.getElementById('librarySection');
            librarySection.style.display = librarySection.style.display === 'none' ? 'block' : 'none';
        }

        // ä½¿ç”¨ç¤ºä¾‹é—®é¢˜
        function useExample(element) {
            const exampleText = element.textContent.trim();
            const startInput = document.getElementById('startInput');
            const chatInput = document.getElementById('chatInput');

            if (startInput && !startInput.classList.contains('hidden')) {
                startInput.value = exampleText;
                startInput.focus();
            } else if (chatInput) {
                chatInput.value = exampleText;
                chatInput.focus();
            }
        }

        // æ¨¡å‹é€‰æ‹©ç›¸å…³
        let currentModel = null;
        let availableModels = [];

        // ä»APIåŠ è½½activeæ¨¡å‹
        async function loadActiveModels() {
            try {
                const response = await fetch('/api/active_models');
                const data = await response.json();
                availableModels = data.models;

                if (availableModels.length > 0) {
                    // ä»localStorageåŠ è½½ä¿å­˜çš„æ¨¡å‹ï¼Œæˆ–ä½¿ç”¨ç¬¬ä¸€ä¸ªæ¨¡å‹
                    const savedModel = localStorage.getItem('selected_model');
                    const defaultModel = savedModel || availableModels[0].value;

                    // æ¸²æŸ“æ¨¡å‹ä¸‹æ‹‰èœå•
                    renderModelDropdown('modelDropdownStart', defaultModel);
                    renderModelDropdown('modelDropdown', defaultModel);

                    // è®¾ç½®å½“å‰æ¨¡å‹
                    const selectedModel = availableModels.find(m => m.value === defaultModel);
                    if (selectedModel) {
                        currentModel = selectedModel.value;
                        updateModelDisplay(selectedModel.name);
                    }
                } else {
                    console.error('æ²¡æœ‰å¯ç”¨çš„activeæ¨¡å‹');
                    updateModelDisplay('æ— å¯ç”¨æ¨¡å‹');
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
                updateModelDisplay('åŠ è½½å¤±è´¥');
            }
        }

        // æ¸²æŸ“æ¨¡å‹ä¸‹æ‹‰èœå•
        function renderModelDropdown(dropdownId, selectedValue) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;

            dropdown.innerHTML = '';

            availableModels.forEach((model, index) => {
                const isActive = model.value === selectedValue;
                const option = document.createElement('div');
                option.className = 'model-option' + (isActive ? ' active' : '');
                option.setAttribute('data-model', model.value);
                option.onclick = function() { selectModel(this); };

                option.innerHTML = `
                    <div class="model-option-name">${model.name}</div>
                    <div class="model-option-desc">${model.description}</div>
                `;

                dropdown.appendChild(option);
            });
        }

        // æ›´æ–°æ¨¡å‹æ˜¾ç¤ºåç§°
        function updateModelDisplay(modelName) {
            const startNameEl = document.getElementById('currentModelNameStart');
            const chatNameEl = document.getElementById('currentModelName');

            if (startNameEl) startNameEl.textContent = modelName;
            if (chatNameEl) chatNameEl.textContent = modelName;
        }

        function toggleModelDropdown() {
            const startDropdown = document.getElementById('modelDropdownStart');
            const chatDropdown = document.getElementById('modelDropdown');

            // åˆ‡æ¢å½“å‰å¯è§é¡µé¢çš„ä¸‹æ‹‰èœå•
            if (startDropdown && !document.getElementById('startContainer').classList.contains('hidden')) {
                startDropdown.classList.toggle('show');
            } else if (chatDropdown) {
                chatDropdown.classList.toggle('show');
            }
        }

        function selectModel(element) {
            const modelValue = element.getAttribute('data-model');
            const selectedModel = availableModels.find(m => m.value === modelValue);

            if (selectedModel) {
                // æ›´æ–°å½“å‰æ¨¡å‹
                currentModel = selectedModel.value;
                updateModelDisplay(selectedModel.name);

                // æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰èœå•çš„activeçŠ¶æ€
                document.querySelectorAll('.model-option').forEach(opt => {
                    if (opt.getAttribute('data-model') === modelValue) {
                        opt.classList.add('active');
                    } else {
                        opt.classList.remove('active');
                    }
                });

                // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
                document.querySelectorAll('.model-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });

                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('selected_model', modelValue);

                console.log('åˆ‡æ¢æ¨¡å‹:', selectedModel.name, modelValue);
            }
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
        document.addEventListener('click', function(event) {
            const modelSelectors = document.querySelectorAll('.model-selector');
            let clickedInside = false;

            modelSelectors.forEach(selector => {
                if (selector.contains(event.target)) {
                    clickedInside = true;
                }
            });

            if (!clickedInside) {
                document.querySelectorAll('.model-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }
        });

        // ä¾§è¾¹æ æœç´¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // é¦–å…ˆåŠ è½½activeæ¨¡å‹åˆ—è¡¨
            loadActiveModels();

            const searchInput = document.getElementById('sidebarSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const chatItems = document.querySelectorAll('.chat-list-item');

                    chatItems.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }

            // åŠ è½½å†å²è®°å½•
            loadChatHistory();
        });

        // åŠ è½½å†å²è®°å½•ï¼ˆé¡µé¢åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼‰
        function loadChatHistory() {
            // ä½¿ç”¨æ–°çš„updateChatHistoryListå‡½æ•°
            updateChatHistoryList();
        }

        // åŠ è½½æŒ‡å®šçš„å¯¹è¯
        function loadConversation(key) {
            try {
                const historyData = JSON.parse(localStorage.getItem(key));
                if (historyData && historyData.conversation) {
                    // è®¾ç½®å½“å‰å¯¹è¯ID
                    currentConversationId = historyData.id;
                    localStorage.setItem('current_conversation_id', historyData.id);

                    // ä¿å­˜åˆ°å½“å‰å¯¹è¯
                    localStorage.setItem('step1_conversation', JSON.stringify(historyData.conversation));

                    // åˆ·æ–°é¡µé¢
                    window.location.reload();
                }
            } catch (e) {
                console.error('åŠ è½½å¯¹è¯å¤±è´¥:', e);
            }
        }

        // ========== åŸæœ‰çš„JavaScriptä»£ç  ==========

        // é…ç½® marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });

        // åˆå§‹åŒ–é¡µé¢çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            // å°è¯•æ¢å¤å½“å‰å¯¹è¯ID
            const savedId = localStorage.getItem('current_conversation_id');
            if (savedId) {
                currentConversationId = savedId;
            }

            // å°è¯•ä»localStorageæ¢å¤å¯¹è¯
            const savedConversation = localStorage.getItem('step1_conversation');
            let conversation = [];

            if (savedConversation) {
                try {
                    conversation = JSON.parse(savedConversation);
                    // æ›´æ–°hidden input
                    document.querySelector('input[name="conversation"]').value = savedConversation;
                } catch (e) {
                    console.error('Failed to parse saved conversation:', e);
                }
            } else {
                // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„åˆå§‹å¯¹è¯
                const serverConversation = document.querySelector('input[name="conversation"]').value;
                if (serverConversation) {
                    conversation = JSON.parse(serverConversation);
                }
            }

            const hasConversation = conversation.length > 2; // system + assistant greeting + user message

            if (hasConversation) {
                // æœ‰å¯¹è¯ï¼Œæ˜¾ç¤ºèŠå¤©ç•Œé¢å¹¶é‡å»ºæ¶ˆæ¯
                showChatInterface();
                rebuildMessages(conversation);
                scrollToBottom();
            } else {
                // æ— å¯¹è¯ï¼Œæ˜¾ç¤ºå¼€å§‹ç•Œé¢
                document.getElementById('startInput').focus();
            }

            // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
            autoResizeTextarea('startInput');
            autoResizeTextarea('chatInput');

            // ä¸ºå¼€å§‹è¾“å…¥æ¡†æ·»åŠ Enteré”®å‘é€åŠŸèƒ½
            const startInput = document.getElementById('startInput');
            if (startInput) {
                startInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendFirstMessage();
                    }
                });
            }

            // ä¸ºèŠå¤©è¾“å…¥æ¡†æ·»åŠ Enteré”®å‘é€åŠŸèƒ½
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        document.getElementById('chatForm').requestSubmit();
                    }
                });
            }

            // å¤„ç†èŠå¤©è¡¨å•æäº¤
            const chatForm = document.getElementById('chatForm');
            if (chatForm) {
                chatForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    handleChatSubmit();
                });
            }

            // åˆå§‹åŒ–ä»·æ ¼è®¡ç®—
            updateSimulationsAndPrice();
        });

        // é‡å»ºæ¶ˆæ¯åˆ—è¡¨ï¼ˆä»localStorageæ¢å¤æ—¶ä½¿ç”¨ï¼‰
        function rebuildMessages(conversation) {
            const messagesContainer = document.getElementById('messagesContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');

            // æ¸…ç©ºç°æœ‰æ¶ˆæ¯ï¼ˆé™¤äº†loading indicatorï¼‰
            while (messagesContainer.firstChild && messagesContainer.firstChild !== loadingIndicator) {
                messagesContainer.removeChild(messagesContainer.firstChild);
            }

            // é‡å»ºæ¶ˆæ¯
            let hasProductDescription = false;
            for (let i = 0; i < conversation.length; i++) {
                const msg = conversation[i];

                if (msg.role === 'user') {
                    const userMessageDiv = document.createElement('div');
                    userMessageDiv.className = 'message user';
                    userMessageDiv.innerHTML = `<div class="message-content">${escapeHtml(msg.content)}</div>`;
                    messagesContainer.insertBefore(userMessageDiv, loadingIndicator);
                } else if (msg.role === 'assistant' && i > 0) { // è·³è¿‡ç¬¬ä¸€æ¡greeting
                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'message assistant';

                    const streamingContent = document.createElement('div');
                    streamingContent.className = 'message-content markdown-content';
                    streamingContent.innerHTML = marked.parse(msg.content);

                    aiMessageDiv.appendChild(streamingContent);
                    messagesContainer.insertBefore(aiMessageDiv, loadingIndicator);

                    // æ£€æŸ¥æ˜¯å¦åŒ…å«äº§å“æè¿°
                    if (msg.content.includes('ã€äº§å“æè¿°ã€‘')) {
                        hasProductDescription = true;
                    }
                }
            }

            // å¦‚æœæœ‰äº§å“æè¿°ï¼Œæ˜¾ç¤ºç¡®è®¤æŒ‰é’®
            if (hasProductDescription) {
                const existingBtn = document.querySelector('.confirm-btn');
                if (!existingBtn) {
                    const sendBtn = document.getElementById('sendBtn');
                    const confirmBtn = document.createElement('button');
                    confirmBtn.type = 'button';
                    confirmBtn.className = 'confirm-btn';
                    confirmBtn.textContent = 'ç¡®è®¤å¹¶ä¸‹ä¸€æ­¥ â†’';
                    confirmBtn.onclick = showConfirmModal;
                    sendBtn.parentNode.appendChild(confirmBtn);
                }
            }
        }

        // å½“å‰å¯¹è¯ID
        let currentConversationId = null;

        // ç”Ÿæˆæ–°çš„å¯¹è¯ID
        function generateConversationId() {
            return 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // è·å–æˆ–åˆ›å»ºå¯¹è¯ID
        function getOrCreateConversationId() {
            if (!currentConversationId) {
                // å°è¯•ä»localStorageæ¢å¤
                const savedId = localStorage.getItem('current_conversation_id');
                if (savedId) {
                    currentConversationId = savedId;
                } else {
                    // ç”Ÿæˆæ–°ID
                    currentConversationId = generateConversationId();
                    localStorage.setItem('current_conversation_id', currentConversationId);
                }
            }
            return currentConversationId;
        }

        // ä¿å­˜å¯¹è¯åˆ°localStorageï¼ˆåŒæ—¶ä¿å­˜åˆ°å½“å‰å’Œå†å²ï¼‰
        function saveConversationToStorage(conversation) {
            try {
                // ä¿å­˜åˆ°å½“å‰å¯¹è¯
                localStorage.setItem('step1_conversation', JSON.stringify(conversation));

                // ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆå¸¦IDï¼‰
                const convId = getOrCreateConversationId();
                const historyData = {
                    id: convId,
                    conversation: conversation,
                    timestamp: Date.now(),
                    title: getConversationTitle(conversation),
                    lastUpdated: new Date().toISOString()
                };

                localStorage.setItem(`step1_conversation_${convId}`, JSON.stringify(historyData));

                // æ›´æ–°å†å²è®°å½•åˆ—è¡¨
                updateChatHistoryList();

                console.log('å¯¹è¯å·²ä¿å­˜:', convId);
            } catch (e) {
                console.error('Failed to save conversation:', e);
            }
        }

        // è·å–å¯¹è¯æ ‡é¢˜ï¼ˆä»ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼‰
        function getConversationTitle(conversation) {
            const firstUserMsg = conversation.find(msg => msg.role === 'user');
            if (firstUserMsg) {
                const title = firstUserMsg.content.substring(0, 30);
                return title + (firstUserMsg.content.length > 30 ? '...' : '');
            }
            return 'æ–°å¯¹è¯';
        }

        // æ›´æ–°ä¾§è¾¹æ å†å²è®°å½•åˆ—è¡¨
        function updateChatHistoryList() {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;

            const allKeys = Object.keys(localStorage);
            const conversationKeys = allKeys.filter(key => key.startsWith('step1_conversation_'));

            if (conversationKeys.length > 0) {
                // åŠ è½½æ‰€æœ‰å†å²è®°å½•å¹¶æŒ‰æ—¶é—´æ’åº
                const histories = conversationKeys.map(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        return {
                            key: key,
                            ...data
                        };
                    } catch (e) {
                        return null;
                    }
                }).filter(h => h !== null);

                // æŒ‰æ—¶é—´é™åºæ’åº
                histories.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                // æ¸…ç©ºå¹¶é‡å»ºåˆ—è¡¨
                chatHistory.innerHTML = '';
                histories.forEach(history => {
                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-list-item';

                    // å¦‚æœæ˜¯å½“å‰å¯¹è¯ï¼Œæ·»åŠ activeæ ·å¼
                    if (history.id === currentConversationId) {
                        chatItem.style.background = '#e5e5e5';
                    }

                    // åˆ›å»ºæ ‡é¢˜å…ƒç´ 
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'chat-title';
                    titleSpan.textContent = history.title || 'æ–°å¯¹è¯';
                    titleSpan.onclick = function(e) {
                        e.stopPropagation();
                        loadConversation(history.key);
                    };

                    // åˆ›å»ºåˆ é™¤æŒ‰é’®
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                    </svg>`;
                    deleteBtn.title = 'åˆ é™¤å¯¹è¯';
                    deleteBtn.onclick = function(e) {
                        e.stopPropagation();
                        deleteConversation(history.key, history.id);
                    };

                    chatItem.appendChild(titleSpan);
                    chatItem.appendChild(deleteBtn);
                    chatHistory.appendChild(chatItem);
                });
            } else {
                chatHistory.innerHTML = '<div class="chat-list-item" style="color: #8e8e93; text-align: center; padding: 20px;">æš‚æ— å†å²è®°å½•</div>';
            }
        }

        function openDeleteConfirmModal() {
            const backdrop = document.getElementById('psDeleteConfirmBackdrop');
            if (!backdrop) return Promise.resolve(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ'));

            const dialog = backdrop.querySelector('.ps-modal');
            const cancelBtn = backdrop.querySelector('[data-action="cancel"]');
            const confirmBtn = backdrop.querySelector('[data-action="confirm"]');
            const prevActive = document.activeElement;

            return new Promise((resolve) => {
                const cleanup = (result) => {
                    backdrop.classList.remove('is-open');
                    backdrop.setAttribute('aria-hidden', 'true');
                    document.removeEventListener('keydown', onKeyDown, true);
                    backdrop.removeEventListener('click', onBackdropClick, true);
                    cancelBtn && cancelBtn.removeEventListener('click', onCancel, true);
                    confirmBtn && confirmBtn.removeEventListener('click', onConfirm, true);
                    if (prevActive && typeof prevActive.focus === 'function') prevActive.focus();
                    resolve(result);
                };

                const onCancel = (e) => {
                    e.preventDefault();
                    cleanup(false);
                };

                const onConfirm = (e) => {
                    e.preventDefault();
                    cleanup(true);
                };

                const onBackdropClick = (e) => {
                    if (e.target === backdrop) cleanup(false);
                };

                const onKeyDown = (e) => {
                    if (e.key === 'Escape') cleanup(false);
                };

                backdrop.classList.add('is-open');
                backdrop.setAttribute('aria-hidden', 'false');

                document.addEventListener('keydown', onKeyDown, true);
                backdrop.addEventListener('click', onBackdropClick, true);
                cancelBtn && cancelBtn.addEventListener('click', onCancel, true);
                confirmBtn && confirmBtn.addEventListener('click', onConfirm, true);

                // èšç„¦ï¼šé»˜è®¤èšç„¦â€œå–æ¶ˆâ€ï¼Œæ›´æ¥è¿‘ ChatGPT çš„å®‰å…¨æ“ä½œä¹ æƒ¯
                if (cancelBtn) cancelBtn.focus();
                else if (dialog) dialog.focus();
            });
        }

        // åˆ é™¤å¯¹è¯
        async function deleteConversation(key, id) {
            const ok = await openDeleteConfirmModal();
            if (!ok) return;

            try {
                // ä»localStorageåˆ é™¤
                localStorage.removeItem(key);

                // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œæ¸…é™¤å½“å‰å¯¹è¯çŠ¶æ€
                if (id === currentConversationId) {
                    currentConversationId = null;
                    localStorage.removeItem('current_conversation_id');
                    localStorage.removeItem('step1_conversation');
                    // åˆ·æ–°é¡µé¢å›åˆ°åˆå§‹çŠ¶æ€
                    window.location.reload();
                } else {
                    // åªæ›´æ–°ä¾§è¾¹æ åˆ—è¡¨
                    updateChatHistoryList();
                }

                console.log('å¯¹è¯å·²åˆ é™¤:', id);
            } catch (e) {
                console.error('åˆ é™¤å¯¹è¯å¤±è´¥:', e);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å¼€å§‹æ–°å¯¹è¯
        function startNewConversation() {
            // æ¸…é™¤å½“å‰å¯¹è¯IDï¼Œä¸‹æ¬¡ä¿å­˜æ—¶ä¼šç”Ÿæˆæ–°ID
            currentConversationId = null;
            localStorage.removeItem('current_conversation_id');
            localStorage.removeItem('step1_conversation');
            window.location.href = '{{ url_for("step1") }}';
        }

        function autoResizeTextarea(id) {
            const textarea = document.getElementById(id);
            if (!textarea) return;

            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });
        }

        function fillExample() {
            document.getElementById('startInput').value = 'ä¸€æ¬¾è†³é£Ÿç®¡ç†APP';
            document.getElementById('startInput').focus();
        }

        function sendFirstMessage() {
            const input = document.getElementById('startInput').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥å†…å®¹');
                return;
            }

            // åˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
            showChatInterface();

            // å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯
            sendMessage(input);
        }

        function showChatInterface() {
            document.getElementById('startContainer').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');

            // èšç„¦åˆ°èŠå¤©è¾“å…¥æ¡†
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                if (chatInput) chatInput.focus();
            }, 100);
        }

        function handleChatSubmit() {
            const input = document.getElementById('chatInput').value.trim();
            if (!input) return;

            sendMessage(input);
        }

        function sendMessage(userInput) {
            const conversationJson = document.querySelector('input[name="conversation"]').value;
            const messagesContainer = document.getElementById('messagesContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const sendBtn = document.getElementById('sendBtn');

            // è§£æç°æœ‰å¯¹è¯
            let conversation = conversationJson ? JSON.parse(conversationJson) : [];

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            conversation.push({"role": "user", "content": userInput});

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆæ’å…¥åˆ°loading indicatorä¹‹å‰ï¼Œç¡®ä¿é¡ºåºæ­£ç¡®ï¼‰
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user';
            userMessageDiv.innerHTML = `<div class="message-content">${escapeHtml(userInput)}</div>`;
            messagesContainer.insertBefore(userMessageDiv, loadingIndicator);  // ä¿®æ”¹ï¼šä½¿ç”¨insertBeforeè€Œä¸æ˜¯appendChild

            // æ¸…ç©ºè¾“å…¥æ¡†
            const startInput = document.getElementById('startInput');
            const chatInput = document.getElementById('chatInput');
            if (startInput) startInput.value = '';
            if (chatInput) {
                chatInput.value = '';
                chatInput.style.height = 'auto';
            }

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loadingIndicator.style.display = 'block';
            if (sendBtn) sendBtn.disabled = true;

            // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨ï¼ˆä¹Ÿæ’å…¥åˆ°loading indicatorä¹‹å‰ï¼‰
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'message assistant';

            const streamingContent = document.createElement('div');
            streamingContent.className = 'message-content markdown-content';

            aiMessageDiv.appendChild(streamingContent);
            messagesContainer.insertBefore(aiMessageDiv, loadingIndicator);  // ç¡®ä¿åœ¨loading indicatorä¹‹å‰

            let fullContent = '';
            let tempTaskId = null;
            let hasProductDescription = false;

            // ä½¿ç”¨fetchè¿›è¡Œæµå¼è¯·æ±‚
            const formData = new FormData();
            formData.append('conversation', JSON.stringify(conversation));

            fetch('{{ url_for("step1_stream") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            // æµç»“æŸ
                            loadingIndicator.style.display = 'none';
                            if (sendBtn) sendBtn.disabled = false;

                            // æ¸²æŸ“æœ€ç»ˆçš„Markdown
                            if (fullContent) {
                                streamingContent.innerHTML = marked.parse(fullContent);
                            }

                            // æ›´æ–°conversation
                            if (hasProductDescription && tempTaskId) {
                                updateConversationAndShowButton(conversation, fullContent, tempTaskId);
                            } else {
                                conversation.push({"role": "assistant", "content": fullContent});
                                document.querySelector('input[name="conversation"]').value = JSON.stringify(conversation);
                                // ä¿å­˜åˆ°localStorage
                                saveConversationToStorage(conversation);
                            }

                            return;
                        }

                        // è§£ç å¹¶å¤„ç†æ•°æ®
                        const chunk = decoder.decode(value, { stream: true });
                        buffer += chunk;

                        // å¤„ç†å®Œæ•´çš„SSEæ¶ˆæ¯
                        const messages = buffer.split('\n\n');
                        buffer = messages.pop() || '';

                        for (let message of messages) {
                            if (!message.trim()) continue;

                            const lines = message.split('\n');
                            for (let line of lines) {
                                if (line.startsWith('data:')) {
                                    const dataStr = line.substring(5).trim();

                                    if (dataStr === '[DONE]') {
                                        continue;
                                    }

                                    try {
                                        const data = JSON.parse(dataStr);

                                        if (data.content) {
                                            fullContent += data.content;
                                            streamingContent.innerHTML = marked.parse(fullContent);
                                            scrollToBottom();
                                        }

                                        if (data.task_id) {
                                            tempTaskId = data.task_id;
                                            hasProductDescription = data.has_product_description;
                                        }

                                        if (data.error) {
                                            console.error('Stream error:', data.error);
                                            streamingContent.innerHTML = `
                                                <div style="color: #dc2626; padding: 16px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
                                                    <div style="font-weight: 500; margin-bottom: 8px;">âŒ é”™è¯¯: ${data.error}</div>
                                                    <div style="font-size: 14px; color: #991b1b; margin-bottom: 12px;">
                                                        å¯èƒ½çš„åŸå› ï¼šç½‘ç»œè¿æ¥ä¸­æ–­æˆ–APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨
                                                    </div>
                                                    <button onclick="location.reload()" style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                                        ğŸ”„ åˆ·æ–°é¡µé¢é‡è¯•
                                                    </button>
                                                </div>
                                            `;
                                            loadingIndicator.style.display = 'none';
                                            if (sendBtn) sendBtn.disabled = false;
                                            return;
                                        }
                                    } catch (e) {
                                        console.error('Parse error:', e);
                                    }
                                }
                            }
                        }

                        readStream();
                    }).catch(error => {
                        console.error('è¯»å–æµé”™è¯¯:', error);
                        loadingIndicator.style.display = 'none';
                        if (sendBtn) sendBtn.disabled = false;
                        streamingContent.innerHTML = `
                            <div style="color: #dc2626; padding: 16px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
                                <div style="font-weight: 500; margin-bottom: 8px;">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>
                                <div style="font-size: 14px; color: #991b1b; margin-bottom: 12px;">
                                    è¿æ¥è¢«ä¸­æ–­ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºç½‘ç»œä¸ç¨³å®šæˆ–æœåŠ¡å™¨è¶…æ—¶
                                </div>
                                <button onclick="location.reload()" style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    ğŸ”„ åˆ·æ–°é¡µé¢é‡è¯•
                                </button>
                            </div>
                        `;
                    });
                }

                readStream();
            })
            .catch(error => {
                console.error('Streaming error:', error);
                loadingIndicator.style.display = 'none';
                if (sendBtn) sendBtn.disabled = false;
                streamingContent.innerHTML = `
                    <div style="color: #dc2626; padding: 16px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
                        <div style="font-weight: 500; margin-bottom: 8px;">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>
                        <div style="font-size: 14px; color: #991b1b; margin-bottom: 12px;">
                            æ— æ³•å»ºç«‹ä¸æœåŠ¡å™¨çš„è¿æ¥ã€‚è¯·æ£€æŸ¥ï¼š
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li>ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸</li>
                                <li>æœåŠ¡å™¨æ˜¯å¦åœ¨è¿è¡Œ</li>
                            </ul>
                        </div>
                        <button onclick="location.reload()" style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ğŸ”„ åˆ·æ–°é¡µé¢é‡è¯•
                        </button>
                    </div>
                `;
            });
        }

        function updateConversationAndShowButton(conversation, fullContent, tempTaskId) {
            conversation.push({"role": "assistant", "content": fullContent});
            conversation.push({"role": "system", "content": `temp_task_id:${tempTaskId}`});

            document.querySelector('input[name="conversation"]').value = JSON.stringify(conversation);

            // ä¿å­˜åˆ°localStorage
            saveConversationToStorage(conversation);

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç¡®è®¤æŒ‰é’®
            const existingBtn = document.querySelector('.confirm-btn');
            if (!existingBtn) {
                const sendBtn = document.getElementById('sendBtn');
                const confirmBtn = document.createElement('button');
                confirmBtn.type = 'button';
                confirmBtn.className = 'confirm-btn';
                confirmBtn.textContent = 'ç¡®è®¤å¹¶ä¸‹ä¸€æ­¥ â†’';
                confirmBtn.onclick = showConfirmModal;
                sendBtn.parentNode.appendChild(confirmBtn);
            }

        }

        function renderMarkdown() {
            const markdownElements = document.querySelectorAll('.markdown-content[data-markdown]');
            markdownElements.forEach(element => {
                const markdownText = element.getAttribute('data-markdown');
                if (markdownText) {
                    element.innerHTML = marked.parse(markdownText);
                }
            });
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æŠ¥å‘Šç”Ÿæˆé¢æ¿
        function showConfirmModal() {
            const panel = document.getElementById('inlineStepPanel');
            if (panel) {
                panel.classList.remove('hidden');
                updateSimulationsAndPrice();
                panel.scrollTop = 0;
            }
        }

        function closeModal() {
            const panel = document.getElementById('inlineStepPanel');
            if (panel) panel.classList.add('hidden');
        }

        function updateSimulationsAndPrice() {
            const personasInput = document.getElementById('num_personas');
            const simulationsInput = document.getElementById('num_simulations');
            if (!personasInput || !simulationsInput) return;

            const personasVal = parseInt(personasInput.value) || 0;
            if (personasVal <= 2) {
                simulationsInput.value = simulationsInput.value || 2;
            }
            updatePrice();
        }

        function updatePrice() {
            const numPersonas = parseInt(document.getElementById('num_personas')?.value) || 0;
            const numSimulations = parseInt(document.getElementById('num_simulations')?.value) || 0;
            const totalPeople = numPersonas * numSimulations;
            const totalMinutes = totalPeople * 6;
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const timeText = hours > 0 ? `${hours}å°æ—¶${minutes}åˆ†é’Ÿ` : `${minutes}åˆ†é’Ÿ`;
            const meta = document.getElementById('reportMeta');
            if (meta) {
                meta.textContent = `ç”¨æˆ·ç”»åƒï¼š${numPersonas} ä¸ª Â· æ¯ä¸ªæ¨¡æ‹Ÿï¼š${numSimulations} æ¬¡ Â· é¢„ä¼°æ€»æ—¶é•¿ï¼š${timeText}`;
            }
        }

        let inlinePollTimer = null;
        let inlineTokenTotal = 0;
        let inlineProgressPct = 0;
        let inlineTokenEstimateController = null;
        let inlineTokenEstimated = false;

        function updateInlineTokenPanel(pct) {
            const tokenPanel = document.getElementById('inlineTokenPanel');
            const tokenFill = document.getElementById('inlineTokenFill');
            const tokenUsedEl = document.getElementById('inlineTokenUsed');
            const tokenTotalEl = document.getElementById('inlineTokenTotal');
            const used = Math.min(inlineTokenTotal, Math.floor(inlineTokenTotal * pct / 100));
            if (tokenPanel) tokenPanel.style.display = 'flex';
            if (tokenFill) tokenFill.style.width = `${Math.min(100, pct)}%`;
            if (tokenUsedEl) tokenUsedEl.textContent = used.toString();
            if (tokenTotalEl) tokenTotalEl.textContent = inlineTokenTotal.toString();
        }

        function startInlineGeneration() {
            const panel = document.getElementById('inlineStepPanel');
            if (panel) panel.classList.remove('hidden');

            const numPersonas = parseInt(document.getElementById('num_personas')?.value) || 2;
            const numSimulations = parseInt(document.getElementById('num_simulations')?.value) || 2;
            updatePrice();
            inlineTokenTotal = Math.max(1, numPersonas * numSimulations * 800); // ä¼°ç®—token
            inlineProgressPct = 0;
            inlineTokenEstimated = false;

            const progress = document.getElementById('inlineProgress');
            const reportCard = document.getElementById('inlineReport');
            const reportContent = document.getElementById('reportContent');
            const meta = document.getElementById('reportMeta');
            const tokenPanel = document.getElementById('inlineTokenPanel');
            const tokenFill = document.getElementById('inlineTokenFill');
            const tokenUsedEl = document.getElementById('inlineTokenUsed');
            const tokenTotalEl = document.getElementById('inlineTokenTotal');
            const statusLabel = document.getElementById('inlineStatusLabel');
            const pctPanel = document.getElementById('inlinePctPanel');
            const pctFill = document.getElementById('inlinePctFill');
            const pctText = document.getElementById('inlinePctText');

            if (inlinePollTimer) {
                clearInterval(inlinePollTimer);
                inlinePollTimer = null;
            }

            if (progress) progress.innerHTML = '';
            if (reportCard) reportCard.classList.add('hidden');
            if (reportContent) reportContent.innerHTML = '';
            if (meta) meta.textContent = '';
            if (tokenPanel) tokenPanel.style.display = 'none';
            if (tokenFill) tokenFill.style.width = '0%';
            if (tokenUsedEl) tokenUsedEl.textContent = '0';
            if (tokenTotalEl) tokenTotalEl.textContent = inlineTokenTotal.toString();
            if (statusLabel) {
                statusLabel.textContent = 'è¿›è¡Œä¸­';
                statusLabel.className = 'inline-status active';
            }
            if (pctPanel) pctPanel.classList.remove('failed');
            if (pctFill) pctFill.style.width = '0%';
            if (pctText) pctText.textContent = '0';

            const steps = [
                { key: 'pending', text: 'è§£æå½“å‰å¯¹è¯ï¼Œæå–äº§å“æè¿°' },
                { key: 'generating_personas', text: 'ç”Ÿæˆç”¨æˆ·ç”»åƒ' },
                { key: 'simulating_reactions', text: 'æ¨¡æ‹Ÿç”¨æˆ·ååº”' },
                { key: 'completed', text: 'æ±‡æ€»è¦ç‚¹å¹¶æ¸²æŸ“æŠ¥å‘Š' }
            ];
            const nodes = [];
            if (progress) {
                steps.forEach(s => {
                    const item = document.createElement('div');
                    item.className = 'progress-item';
                    item.innerHTML = `<span class="progress-dot"></span><span>${s.text}</span>`;
                    nodes.push(item);
                    progress.appendChild(item);
                });
            }

            // å¯åŠ¨åç«¯ä»»åŠ¡
            const conversationJson = document.querySelector('input[name="conversation"]')?.value || '[]';
            const formData = new FormData();
            formData.append('conversation', conversationJson);
            formData.append('num_personas', numPersonas);
            formData.append('num_simulations', numSimulations);

            startInlineTokenEstimate(conversationJson, numPersonas, numSimulations);

            fetch('/api/inline_task', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (!data.task_id) {
                        throw new Error(data.error || 'åˆ›å»ºä»»åŠ¡å¤±è´¥');
                    }
                    pollInlineStatus(data.task_id, nodes, steps);
                })
                .catch(err => {
                    if (reportContent) {
                        reportContent.innerHTML = `<div style="color:#dc2626;">ä»»åŠ¡åˆ›å»ºå¤±è´¥ï¼š${err.message}</div>`;
                        if (reportCard) reportCard.classList.remove('hidden');
                    }
                });
        }

        function startInlineTokenEstimate(conversationJson, numPersonas, numSimulations) {
            if (inlineTokenEstimateController) {
                inlineTokenEstimateController.abort();
            }
            inlineTokenEstimateController = new AbortController();

            const formData = new FormData();
            formData.append('conversation', conversationJson);
            formData.append('num_personas', numPersonas);
            formData.append('num_simulations', numSimulations);

            fetch('/api/token_estimate', {
                method: 'POST',
                body: formData,
                signal: inlineTokenEstimateController.signal
            }).then(response => {
                if (!response.body) return;
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                function readEstimate() {
                    reader.read().then(({ done, value }) => {
                        if (done) return;

                        buffer += decoder.decode(value, { stream: true });
                        const messages = buffer.split('\n\n');
                        buffer = messages.pop() || '';

                        messages.forEach(message => {
                            if (!message.trim()) return;
                            const lines = message.split('\n');
                            lines.forEach(line => {
                                if (!line.startsWith('data:')) return;
                                const dataStr = line.substring(5).trim();
                                if (dataStr === '[DONE]') return;
                                try {
                                    const data = JSON.parse(dataStr);
                                    if (data.estimate) {
                                        inlineTokenTotal = Math.max(1, parseInt(data.estimate, 10));
                                        inlineTokenEstimated = true;
                                        updateInlineTokenPanel(inlineProgressPct);
                                    }
                                } catch (err) {
                                    console.error('è§£ætokenä¼°è®¡å¤±è´¥:', err);
                                }
                            });
                        });

                        readEstimate();
                    }).catch(() => {});
                }

                readEstimate();
            }).catch(err => {
                console.error('tokenä¼°è®¡å¤±è´¥:', err);
            });
        }

        function pollInlineStatus(taskId, nodes, steps) {
            function renderStatus(status, progressData, eta) {
                const mapIndex = {
                    'pending': 0,
                    'generating_personas': 1,
                    'simulating_reactions': 2,
                    'completed': 3,
                    'failed': 3
                };
                const activeIdx = mapIndex[status] ?? 0;
                nodes.forEach((n, idx) => {
                    n.classList.remove('active', 'done');
                    if (idx < activeIdx) n.classList.add('done');
                    if (idx === activeIdx) n.classList.add('active');
                });

                const meta = document.getElementById('reportMeta');
                if (meta && eta) {
                    meta.textContent = `ä»»åŠ¡çŠ¶æ€ï¼š${status} Â· é¢„è®¡å‰©ä½™ï¼š${eta}`;
                }

                const statusLabel = document.getElementById('inlineStatusLabel');
                const pctPanel = document.getElementById('inlinePctPanel');
                const pctFill = document.getElementById('inlinePctFill');
                const pctText = document.getElementById('inlinePctText');

                const tokenPanel = document.getElementById('inlineTokenPanel');
                const tokenFill = document.getElementById('inlineTokenFill');
                const tokenUsedEl = document.getElementById('inlineTokenUsed');
                const tokenTotalEl = document.getElementById('inlineTokenTotal');
                const pct = progressData?.percentage || 0;
                if (!inlineTokenEstimated && progressData?.total_tokens) {
                    inlineTokenTotal = progressData.total_tokens;
                }
                inlineProgressPct = pct;
                updateInlineTokenPanel(pct);

                if (pctFill) pctFill.style.width = `${Math.min(100, Math.max(0, pct))}%`;
                if (pctText) pctText.textContent = `${Math.round(Math.min(100, Math.max(0, pct)))}`;

                if (statusLabel) {
                    const statusText = ({
                        pending: 'å‡†å¤‡ä¸­',
                        generating_personas: 'ç”Ÿæˆç”»åƒ',
                        simulating_reactions: 'æ¨¡æ‹Ÿä¸­',
                        completed: 'å·²å®Œæˆ',
                        failed: 'å¤±è´¥'
                    })[status] || status;
                    statusLabel.textContent = statusText;
                    statusLabel.className = 'inline-status' + (status === 'completed' ? ' done' : status === 'failed' ? ' failed' : ' active');
                }

                if (pctPanel) {
                    if (status === 'failed') pctPanel.classList.add('failed');
                    else pctPanel.classList.remove('failed');
                }
            }

            const reportCard = document.getElementById('inlineReport');
            const reportContent = document.getElementById('reportContent');

            inlinePollTimer = setInterval(() => {
                fetch(`/api/task/${taskId}/status`)
                    .then(res => res.json())
                    .then(data => {
                        renderStatus(data.status, data.progress, data.estimated_completion_time);

                        if (data.status === 'completed') {
                            clearInterval(inlinePollTimer);
                            inlinePollTimer = null;
                            renderInlineReport(data);
                        } else if (data.status === 'failed') {
                            clearInterval(inlinePollTimer);
                            inlinePollTimer = null;
                            if (reportContent) {
                                reportContent.innerHTML = `<div style="color:#dc2626;">ä»»åŠ¡å¤±è´¥ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                                if (reportCard) reportCard.classList.remove('hidden');
                            }
                        }
                    })
                    .catch(err => {
                        clearInterval(inlinePollTimer);
                        inlinePollTimer = null;
                        if (reportContent) {
                            reportContent.innerHTML = `<div style="color:#dc2626;">è½®è¯¢å¤±è´¥ï¼š${err.message}</div>`;
                            if (reportCard) reportCard.classList.remove('hidden');
                        }
                    });
            }, 2000);
        }

        function renderInlineReport(data) {
            const reportCard = document.getElementById('inlineReport');
            const reportContent = document.getElementById('reportContent');
            const meta = document.getElementById('reportMeta');
            if (!reportContent || !meta) return;

            const stats = data.stats || {};
            const totalPersonas = stats.total_personas || (parseInt(document.getElementById('num_personas')?.value) || 0);
            const totalSim = stats.total_simulations || (parseInt(document.getElementById('num_simulations')?.value) || 0);
            meta.textContent = `ç”¨æˆ·ç”»åƒï¼š${totalPersonas} Â· æ€»æ¨¡æ‹Ÿï¼š${totalSim}`;

            const wouldBuy = stats.would_buy_percentage ?? '-';
            const mustHave = stats.must_have_percentage ?? '-';
            const wouldTry = stats.would_try_percentage ?? '-';
            const reportUrl = data.report_url || '';

            reportContent.innerHTML = `
                <div style="font-size:13px;color:#475569;margin-bottom:8px;">
                    ä»»åŠ¡å®Œæˆï¼Œä»¥ä¸‹ä¸ºæ ¸å¿ƒæŒ‡æ ‡ï¼š
                </div>
                <div class="report-card" style="border:none;padding:0;background:transparent;box-shadow:none;">
                    <div style="margin-bottom:8px;">æ„¿æ„è´­ä¹°æ¯”ä¾‹ï¼š<strong>${wouldBuy}%</strong></div>
                    <div style="margin-bottom:8px;">åˆšéœ€æ¯”ä¾‹ï¼š<strong>${mustHave}%</strong></div>
                    <div style="margin-bottom:8px;">æ„¿æ„å°è¯•æ¯”ä¾‹ï¼š<strong>${wouldTry}%</strong></div>
                    ${reportUrl ? `<div style="margin-top:12px;">
                        <a href="${reportUrl}" target="_blank" style="color:#2563eb;text-decoration:underline;">ä¸‹è½½HTMLæŠ¥å‘Š</a>
                    </div>` : ''}
                </div>
            `;

            reportCard.classList.remove('hidden');
        }

        function getLatestAssistantHtml() {
            const assistantMessages = document.querySelectorAll('.message.assistant .message-content');
            if (assistantMessages.length === 0) return '';
            return assistantMessages[assistantMessages.length - 1].innerHTML;
        }
    </script>

    <!-- åˆ é™¤å¯¹è¯ç¡®è®¤å¼¹çª—ï¼ˆæ›¿ä»£æµè§ˆå™¨ confirmï¼‰ -->
    <div id="psDeleteConfirmBackdrop" class="ps-modal-backdrop" aria-hidden="true">
        <div class="ps-modal" role="dialog" aria-modal="true" aria-labelledby="psDeleteConfirmTitle" aria-describedby="psDeleteConfirmDesc" tabindex="-1">
            <div id="psDeleteConfirmTitle" class="ps-modal-title">åˆ é™¤å¯¹è¯ï¼Ÿ</div>
            <div id="psDeleteConfirmDesc" class="ps-modal-desc">åˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚</div>
            <div class="ps-modal-actions">
                <button type="button" class="ps-btn ps-btn-ghost" data-action="cancel">å–æ¶ˆ</button>
                <button type="button" class="ps-btn ps-btn-danger" data-action="confirm">åˆ é™¤</button>
            </div>
        </div>
    </div>
</body>
</html>

